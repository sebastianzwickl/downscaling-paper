\section{Materials and methods}\label{methodology}
This section explains the methodology developed in this work. Section \ref{pop} describes proportional spatial downscaling using population as a proxy. Building on this, section \ref{alg1} presents the sequential downscaling and section \ref{alg2} presents the iterative downscaling algorithm in detail. Finally, section \ref{open} concludes this section and explains the open-source tools used in this work.

\subsection{Proportional spatial downscaling using population as a proxy}\label{pop}
Proportional downscaling is a well-established technique for spatial disaggregation and is often used in scientific and practical studies. Equation \ref{eq:1} shows a mathematical formulation of proportional downscaling for disaggregation of energy demand $d$ from the country to the local levels, using population $p$ as a proxy.
\begin{align}\label{eq:1}
d_{local}=\frac{p_{local}}{p_{country}} \cdot d_{country}
\end{align}
The fields of application of proportional downscaling are not limited to the modeling of energy systems but to different fields of scientific and practical studies. The reason for this is the intuitive application and that it offers possibilities for tailor-made adaptions, in particular, related to the downscaling driver and proxy \cite{van2006downscaling}. In this context, van Vuuren et al. \cite{van2006downscaling} provide a comprehensive analysis of different proxies for the downscaling of global environmental change, including gross domestic product, emissions and other indicators. However, in the context of downscaling aggregated values of energy systems, one often finds proportional downscaling using population as a proxy (see, e.g., Ahn et al. \cite{ahn2019downscaled}, van Vuuren et al. \cite{van2010downscaling}, and Alam et al. \cite{alam2018downscaling}). For further information, we refer the reader to van Vuuren's study \cite{van2010downscaling}, providing a systematic classification of downscaling techniques going far beyond the simple proportional downscaling method discussed so far. The reader can find population-based downscaling in the authors' categorization under algorithmic and proportional downscaling. In addition, they showed that novel downscaling methods have emerged in recent years as the scientific community has increasingly recognized the necessity for spatial and temporal disaggregation.

\subsection{Sequential downscaling (from the country to the sub-region level)}\label{alg1}
The sequential approach (Algorithm 1) downscales the heat generation by source from the country to the sub-region levels. Before explaining the algorithm in detail, Table \ref{tab:nuts} provides an overview of the spatial nomenclature of this work using the European nomenclature of territorial units for statistics\footnote{\url{https://ec.europa.eu/eurostat/web/nuts/background}.} (NUTS) and gives some examples of Austria. In particular, the different spatial levels of the applied downscaling are marked in gray. According to the NUTS nomenclature, Algorithm 1 downscales from the NUTS0 level to the NUTS3 level.\vspace{0.3cm}

\definecolor{Gray}{gray}{0.95}
\begin{sidewaystable}
	\centering
	\setlength{\extrarowheight}{.5em}
	\scalebox{0.85}{
		\begin{tabular}{cccc}
			\toprule
			NUTS level  & Description & Number& Example (population)\\\hline
			\cellcolor{Gray}NUTS0 & \cellcolor{Gray}Country level & \cellcolor{Gray}1 & \cellcolor{Gray}AT Austria (8.86 million)\\
			NUTS1 & Major socioeconomic regions & 3 & AT3 Western Austria (2.78 million)\\
			NUTS2 & Basic regions for the application of regional policies (federal states) & 9 & AT31 Upper Austria (1.48 million)\\
			\cellcolor{Gray}NUTS3 & \cellcolor{Gray}(Small) sub-regions for specific diagnoses (political/court districts) & \cellcolor{Gray}35 & \cellcolor{Gray}AT312 Linz-Wels (529 thousand)\\
			\cellcolor{Gray}LAU (former NUTS4/5) & \cellcolor{Gray}Subdivision of the NUTS 3 regions (communities)& \cellcolor{Gray}2095 & \cellcolor{Gray}Enns AT312 Linz-Wels (11 thousand)\\ 
			\bottomrule
	\end{tabular}}
	\caption{Spatial nomenclature of different spatial levels using the NUTS nomenclature. Besides the number of regions per NUTS level, examples for the Austrian case study (incl. population) are given. The gray-colored rows mark the spatial levels used for downscaling in this work.}
	\label{tab:nuts}
\end{sidewaystable}

The purpose of the sequential downscaling algorithm is to provide a downscaling technique that considers the variation in efficiency of renewable heat sources and the increasing role of biomass and waste heat sources, in particular, in densely populated areas. Hence, we claim that 

\begin{itemize}
	\item limited amounts of hydrogen (and/or "green" gas) should preferably be used in district heating networks if they are used for heat supply (similar to Gerhardt et al.  \cite{gerhardt2020hydrogen} and Zwickl-Bernhard and Auer \cite{zwickl2021demystifying}).
	\item high shares of biomass in the heating sector result in a high utilization rate of waste sources in waste incineration plants \cite{fruergaard2010energy}. These waste incineration plants feed into district heating and therefore depend on the infrastructure of centralized heating networks (see, e.g., Sahlin et al. \cite{sahlin2004effects}).
\end{itemize}

Besides, we claim that high shares of air-source heat pumps (or geothermal sources) in the heat supply can only be realized if they are used as a co-firing heat source in district heating networks. We therefore consider two main aspects, namely that geothermal sources will contribute significantly to decarbonizing the feed-in energy mix of existing district heating grids in the future (see, e.g., \cite{weinand2019developing}), and that the provision of high shares of geothermal-based heat supply requires the distribution through district heating infrastructure \cite{dalla2020scenarios}. Besides, it is highly uncertain whether small-scale geothermal units at the end-user's level will be economically viable in the future, because of the high investment costs expected.\vspace{0.3cm}

To incorporate the abovementioned relevant technology-specific aspects, heat technologies/sources are downscaled according to their necessity of distribution infrastructure. Therefore, population density serves as a criterion, indicating the possibility of centralized heat networks. Table \ref{tab:require} provides a qualitative overview of the different heat generation technologies/sources and their heat network/infrastructure requirements.\vspace{0.3cm}

\definecolor{Gray}{gray}{0.85}
\begin{table}[h]
	\centering
	\setlength{\extrarowheight}{.5em}
	\scalebox{0.85}{
		\begin{tabular}{ccccc|l}
			\toprule
			\underline{Source} & \underline{Requirements} & Rural & Town/Mixed & Urban&\multirow{2}{*}{\vtop{\hbox{\strut Supporting}\hbox{\strut references}}}\\
			Heat technology & Heat network & Sparse & Moderate & Dense&\\\hline
			Biomass & Median & &  \cellcolor{Gray}x & \cellcolor{Gray}x&\cite{vallios2009design,ericsson2016introduction, fruergaard2010energy}\\
			Direct electric & None &  x & x & x&\\
			Synthetic gas & Low & x & x & x&\\
			Hydrogen & High &  &  &  \cellcolor{Gray}x& \cite{jensen2020potential, dodds2015hydrogen, arsalis2019thermodynamic}\\
			Heat pump (air) & None &  x & x & x&\cite{yang2018using}\\
			Heat pump (ground) & High &  &  &  \cellcolor{Gray}x& \cite{kyriakis2016towards, unternahrer2017spatial, weinand2019developing}\\
			Heat storage & None &  x & x & x&\\
			\bottomrule
	\end{tabular}}
	\caption{Qualitative overview of heat generation technologies/sources and their requirements for heat network infrastructure. The prioritized preferences of heat sources in sub-regions are marked by the gray cell. In addition, selected references supporting this assumptions are cited.}
	\label{tab:require}
\end{table}

The sub-regions used to downscale the corresponding heat sources are marked. Note that the different types are characterized by population density. Exemplarily, direct electric heating is a heat generation technology with no significant heat network requirements. It is downscaled to all types of sub-regions. In contrast, hydrogen is a heat source with high requirements and thus prioritized preferences (marked by the gray cell color). The right column refers to selected references whose key findings are in line with this approach/these assumptions. Building on this, the sequential downscaling algorithm is presented below (Algorithm 1).\vspace{0.6cm}

\scalebox{1}{
	\begin{algorithm}[H]
		\setstretch{1}
		\SetKwInOut{Input}{input}
		\SetKwInOut{Output}{output}
		\SetKwInput{kwInit}{Initialization}
		$t$: Heat generation by technology/source $(t \in \mathcal{T})$\;
		$r$: Sub-region (or NUTS3 region) $(r \in \mathcal{R})$\;
		\vspace{0.2cm}
		\Input{Heat generation by technology/source at NUTS0 level: $(q_{t})$;\newline
			Population density per sub-region $r$ $(\rho_{r})$;\newline
			Total population per sub-region $r$ $(p_{r})$;\newline
			Minimal network infrastructure requirements of $t$ $(\sigma_{t})$;\newline
			Available potential of heat network infrastructure at $r$ ($\pi_{r}$)\;}
		\vspace{0.2cm}
		\Output{Heat generation by technology/source at NUTS3 level $(\hat{q}_{t,r})$\;}
		\vspace{0.2cm}
		\kwInit{\\
			Sort elements $t$ in $T$ descending by $\sigma_{t}$\;
			$q^{heat}_{r} \longleftarrow \sum_{t} q_{t} \cdot \frac{p_{r}}{\sum_{r} p_{r}}$ \tcp*{Calculate heat demand at each sub-region}
			$\tilde{q}_{t} \longleftarrow q_{t}$ \tcp*{Available heat generation for each technology/source}
			$\pi_{r} \longleftarrow \rho_{r}$ \tcp*{Population density determines network potential}
			\vspace{0.2cm}}
		\SetAlgoLined
		\Begin{
			\ForEach{$t$}{
				$List=[~]$\tcp*{Collect valid sub-regions}
				$demand=0$\tcp*{Remaining demand that needs to be covered}
				$R^{'}=R\setminus \{\forall r \in R: \pi_{r} \leq \sigma_{t}\}$\tcp*{Get valid sub-regions by criteria}
				\ForEach{$r^{'} \in R^{'}$}{
					\If{$q^{heat}_{r} \ge 0$}{
						$List = List \cup r^{'}$\tcp*{Add valid sub-regions to collection} 
						$demand\mathrel{+}=q^{heat}_{r}$\tcp*{Total demand of valid sub-regions}}}
				\ForEach{$l \in List$}{
					$\hat{q}_{t,r} = \frac{q^{heat}_{r}}{demand}\cdot \tilde{q}_{t}$\tcp*{Population-based downscaling}
					$q^{heat}_{r} \mathrel{-}= \hat{q}_{t,r}$\tcp*{Reduce heat demand at $r$}
				}
			}
		}\caption{Sequential downscaling algorithm (NUTS0 to NUTS3)}
		\label{Alg:1}
\end{algorithm}}\vspace{0.6cm}

The inputs are as follows: (i) heat generation by technology/source at the NUTS0 level, (ii) population as well as population density at the NUTS3 level, and (iii) empirical assumptions in terms of network infrastructure requirements per heat technology/source and potentials for heat network infrastructure (see Table \ref{tab:require}). The algorithm itself consists of three main parts: initialization, pre-calculations, and downscaling. First, the initialization of the algorithm sorts the heat generation technologies/sources in descending order in terms of network infrastructure requirements. Then, the calculation starts with the first technology/source (highest requirements) (line 6). For this technology/source, all possible sub-regions are collected (line 9). Those sub-regions already fully supplied (no remaining heat demand) are filtered out (line 11). After further pre-calculation steps, the available amount of heat generation is downscaled to all valid sub-regions using population as a proxy. This procedure is repeated sequentially for each heat technology/source. The outputs of the sequential downscaling algorithm are heat generation by source and the amount of heat demand covered by centralized heat networks at the NUTS3 level.

\subsection{Iterative downscaling (from the sub-region to community levels)}\label{alg2}
This section explains the methodology of the iterative downscaling algorithm. We propose this downscaling technique projecting heat generation by technology/source from the sub-region (NUTS3) to the community levels (LAU) (see Table \ref{tab:nuts}). This in-depth spatial resolution is imperative for realistic network infrastructure planning, as stated by Zvoleff et al. \cite{zvoleff2009impact}. The underlying concept of iterative downscaling is based on graph theory and assessing network topology using benchmark indicators. 

\scalebox{1}{
	\begin{algorithm}[H]
		\setstretch{1}
		\SetKwInOut{Input}{input}
		\SetKwInOut{Output}{output}
		\SetKwInput{kwInit}{Initialization}
		$s$: Stage of iteration $(s \in \{0, 1, *\})$\;
		$G^{s}$: Centralized heat network graph at stage $s$\;
		$N^{s}$: List of nodes at stage $s$: ($n^{s} \in N^{s}$)\;
		$L^{s}$: List of lines connecting nodes $k$ and $j$ at stage $s$: ($l^{s}_{k,j} \in L^{s}$)\;
		$Q^{s}$: Centralized heat generation at stage $s$: $(q^{s}_{n^{s}} \in Q^{s})$\;
		$\tilde{Q^{s}}$: On-site heat generation at stage $s$: $(\tilde{q}^{s}_{n^{s}} \in \tilde{Q^{s}})$\;
		$\Pi^{s}$: Benchmark indicator value at stage $s$ ($\pi^{s}_{n^{s}} \in \Pi^{s}$)\;
		\vspace{0.2cm}
		\Input{$G^{0}=\{N^{0}, L^{0}, Q^{0}, \tilde{Q^{0}\}}$\;}
		\Output{$G^{*}=\{N^{*}, L^{*}, Q^{*}, \tilde{Q^{*}\}}$\;}
		\vspace{0.2cm}
		\kwInit{\\
			$s=0$, $iter=True$\;	
		}
		\SetAlgoLined
		\Begin{
			\While{$iter=True$}{
				\ForEach{$n \in N\textsuperscript{s}$}{
					$\Pi^{s}_{n^{s}}=f(N^{s}, L^{s}, Q^{s})$\tcp*{Calculate benchmark indicator value}}
				$i$ with $\pi^{s}_{i}=min(\Pi^{s}$)\tcp*{Get node with lowest indicator value}
				$N^{s+1}=N^{s} \setminus i$\tcp*{Remove node from graph obtaining next stage}
				$\tilde{q} = \sum_{N^{s+1}} \tilde{q}^{s}_{n^{s}}$\tcp*{Calculate available on-site heat generation}
				\eIf{$\tilde{q} \geq q^{s}_{i}$}{
					\ForEach{$n^{s+1}$}{
						$q^{s+1}_{n^{s+1}} = q^{s}_{n^{s}}+\frac{q^{s}_{i}}{\tilde{q}}\cdot \tilde{q}^{s}_{n^{s}}$\tcp*{Increase centralized heat amount}
						$\tilde{q}^{s+1}_{n^{s+1}} = \tilde{q}^{s}_{n^{s}}-\frac{q^{s}_{i}}{\tilde{q}} \cdot \tilde{q}^{s}_{n^{s}}$\tcp*{Decrease on-site heat amount}}
					$L^{s+1}=L^{s} \setminus \{\forall l^{s}_{k,j}: k=i \lor j=i\}$\tcp*{Remove connecting lines}
					$G^{s+1}=\{N^{s+1}, L^{s+1}, Q^{s+1}, \tilde{Q^{s+1}\}}$\tcp*{Create new network graph}
					$G^{s} = G^{s+1}$\tcp*{Set updated heat network graph as new input}
				}
			{
				$iterate=False$\tcp*{Stop iteration because of no reallocation}
				$G^{*} = G^{s}$\tcp*{Set heat network graph as result}}}}
		\caption{Iterative downscaling algorithm (NUTS3 to LAU level)}
		\label{Alg:2}
	\end{algorithm}
}\vspace{0.6cm}

\subsubsection{Algorithm description}
The iterative downscaling algorithm is presented in Algorithm 2. The idea is to assess, benchmark, and improve the topology of centralized heat networks. This is achieved in our proposed approach by iterative downscaling. Essentially, the main steps of the algorithm can be summarized as follows:

\begin{enumerate}[nolistsep]
	\item Downscale the results of the sequential downscaling algorithm from the NUT3 to the LAU levels using population as the downscaling driver, to obtain the initial heat network graph $G^{0}$ (input).
	\item Benchmark each node of the heat network graph (line 11), identify the node with the lowest indicator value, and remove the node from the graph, generating a reduced heat network graph (lines 13 and 14).
	\item Check if the amounts of centralized and on-site heat generation can be reallocated (line 16).
	\item If yes, reallocate centralized and on-site heat generation for all nodes (lines 18 and 19); otherwise stop algorithm.
	\item Update heat network graph and jump to step 2.
\end{enumerate}
\vspace{0.5cm}

Recent studies support this approach, focusing on the topography of energy systems and networks (see, e.g., \cite{abuelnasr2018examining}). Bordin et al. \cite{bordin2016optimization} conduct an approach for the optimized strategic network design of centralized heat systems. Allen et al. \cite{allen2020evaluation} evaluate the topology of centralized heating systems and conclude that the optimization of the topology is promising to facilitate the adoption of centralized heat networks. 

\subsubsection{Heat network topology benchmarking using graph theory}\label{bench}
So far, we have introduced only the function $f(N^{s}, L^{s}, Q^{s})$ (see line 11 in the iterative algorithm (Algorithm 2)) as a calculation procedure of the benchmarking indicator value. Below, we describe and discuss the approach of using a weighted cluster coefficient as a function and benchmarking indicator.\vspace{0.3cm}

The proposed benchmarking indicator value is derived from graph theory. Detailed information in the context of network analysis using indicators can be found in the fundamental work by Strogatz \cite{strogatz2001exploring}. Morever, we refer the reader to Sanfeliu and Fu \cite{sanfeliu1983distance}, in which network topologies and their transformation are described in detail. In this work, we use a weighted cluster coefficient as a benchmark indicator and determine the transformation path of the centralized heat network graph. Equation \ref{eq:2} shows the calculation of the weighted cluster coefficient

\begin{align}\label{eq:2}
c_{n^{s}}=\frac{q_{n^{s}}}{max~q^{s}}\cdot \frac{\alpha_{n^{s}}}{\beta_{n^{s}}}
\end{align}

where $q$ is the amount of centralized heat supply, $\alpha$ is the number of triangles that can be formed with direct neighboring nodes, and $\beta$ is the number of lines connecting to the graph for node $n$ at stage $s$. In the context of the fundamental concept of $alpha$, we refer again to the literature. In particular, the study in \cite{huang2010link} comprehensively deals with cluster coefficients and provides related generalized concepts. In addition, relevant aspects of the cluster(ing) coefficient are shown in \cite{cui2014detecting}. In the works cited and also in this study, the aim is to achieve a high value of the cluster coefficient for each node considered (i.e., $\frac{\alpha}{\beta} \approx 1$). However, we extend the basic concept of the cluster coefficient from the literature and propose a weighting with the relative centrally supplied heat quantity. From an energy economics point-of-view, at least two important aspects are considered in the benchmarking process: (i) a high connection rate to the centralized heat network and (ii) a connection of those areas to the network that have a high heat demand and heat density, respectively. Both aspects are investigated in the literature. For example, Nilsson et al. \cite{nilsson2008sparse} focus on the importance of the connection rate of centralized heat networks. Besides, Dochev et al. \cite{dochev2018analysing} investigate the impact of linearly decreasing heat densities and the influence on the profitability of the centralized heat networks.

\subsection{Development of an open-source package building on pyam}\label{open}
The method described will be released as an open-source Python package in the course of publishing this work at the author's GitHub account. In this package, we build on the existing open-source Python package \textit{pyam} \cite{huppmann2021pyam}. \textit{Pyam} is an open-source package for the analysis and visualization of integrated assessment and macro-energy scenarios. In this work, it is used particularly for (i) the linkage between the sequential and the iterative downscaling algorithms, (ii) the internal calculation steps within both downscaling algorithms, and (iii) the visualization of the results. Besides, we used the open-source Python package \textit{networkx} \cite{hagberg2008exploring}, when implementing the iterative downscaling algorithm. We refer to the repository for the codebase, data collection, and further information. 
